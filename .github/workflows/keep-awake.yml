name: Keep HuggingFace Space Awake (Private)

on:
  schedule:
    - cron: '0 */2 * * *'  # Her 2 saatte bir (00:00, 02:00, 04:00...)
  workflow_dispatch:  # Manuel tetikleme için buton

jobs:
  keep-awake:
    runs-on: ubuntu-latest
    name: Check HuggingFace Space Status
    steps:
      - name: Check Space Status via HuggingFace API
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          echo "=== Step 1: Getting API Response ==="
          api_response=$(curl -s -H "Authorization: Bearer $HF_TOKEN" \
            "https://huggingface.co/api/spaces/aassr/borsa-tavan-takip")
          
          if [ -z "$api_response" ]; then
            echo "❌ Empty API response"
            exit 1
          fi
          
          echo "=== RAW API RESPONSE ==="
          echo "$api_response"
          echo "======================"
          
          echo ""
          echo "=== Step 2: Testing Multiple Selectors ==="
          
          # Selector 1: .stage (current)
          status1=$(echo "$api_response" | jq -r '.stage' 2>/dev/null)
          echo "Selector 1 (.stage): '$status1'"
          
          # Selector 2: .domains[0].stage (domain stage)
          status2=$(echo "$api_response" | jq -r '.domains[0].stage' 2>/dev/null)
          echo "Selector 2 (.domains[0].stage): '$status2'"
          
          # Selector 3: .runtime.stage (runtime stage)
          status3=$(echo "$api_response" | jq -r '.runtime.stage' 2>/dev/null)
          echo "Selector 3 (.runtime.stage): '$status3'"
          
          # Selector 4: Any stage field
          status4=$(echo "$api_response" | jq -r '.stage' 2>/dev/null)
          echo "Selector 4 (fallback .stage): '$status4'"
          
          echo ""
          echo "=== Step 3: Using First Valid Status ==="
          
          final_status=""
          
          # Önce .stage kontrol et (null değilse ve RUNNING ise)
          if [ "$status1" = "RUNNING" ]; then
            final_status="$status1"
            echo "✅ Using root .stage status"
          # Sonra domain stage kontrol et
          elif [ "$status2" = "READY" ] || [ "$status2" = "RUNNING" ]; then
            final_status="$status2"
            echo "✅ Using domain status ($status2)"
          # En son runtime stage kontrol et
          elif [ "$status3" = "RUNNING" ]; then
            final_status="$status3"
            echo "✅ Using runtime status"
          # Hiçbiri yoksa null olarak ayarla
          else
            final_status="null"
            echo "⚠️ No valid status found, using null"
          fi
          
          echo "Final status to check: '$final_status'"
          
          echo ""
          echo "=== Step 4: Status Check ==="
          if [ "$final_status" = "RUNNING" ] || [ "$final_status" = "READY" ]; then
            echo "✅ Space is awake and running"
          else
            echo "⚠️ Space is not running (Status: $final_status)"
            echo "ℹ️  Monitoring only - NOT restarting"
          fi